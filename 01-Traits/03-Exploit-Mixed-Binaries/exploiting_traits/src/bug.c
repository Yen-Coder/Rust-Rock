// src/bug.c
#include <stdio.h>
#include <stdint.h>

// This function simulates a vulnerable C/C++ function that corrupts memory
void bug(uintptr_t ptr) {
    printf("C function called with pointer: 0x%lx\n", (unsigned long)ptr);
    
    // WARNING: This is intentionally vulnerable code for demonstration
    // Cast the pointer to access the trait object's fat pointer
    // In Rust's representation for trait objects:
    // - First 8 bytes: pointer to data
    // - Next 8 bytes: pointer to vtable
    
    uintptr_t* fat_ptr = (uintptr_t*)ptr;
    
    printf("  Data pointer:   0x%lx\n", (unsigned long)fat_ptr[0]);
    printf("  VTable pointer: 0x%lx\n", (unsigned long)fat_ptr[1]);
    
    // Corrupt the VTable pointer - this simulates memory corruption
    // that could redirect execution to attacker-controlled code
    uintptr_t malicious_vtable = 0x4141414141414141ULL; // Example malicious address
    
    printf("  Corrupting VTable pointer to: 0x%lx\n", (unsigned long)malicious_vtable);
    fat_ptr[1] = malicious_vtable;
    
    printf("  VTable corruption completed!\n");
}
